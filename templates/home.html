{% extends 'base.html' %} {% block content %}
<div class='posts'>

    {% for post in posts %}
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-preview">
                <a href="post.html">
                    <div class='post-title'>
                        <h2><a href='/article?key={{post.key| filterKey}}'>{{post.title}}</a></h2>
                    </div>
                    <div class='post-message'>
                        {{post.message}}
                    </div>
                    <div class='created_at'>
                        {{post.created_at}}
                    </div>

                    <div class='social-buttons'>
                        Likes
                        <div class='likes' id={{post.key | filterKey}}>
                            {{post.likes | length}}
                        </div>
                        <div type=''>
                            {% if post.likes | length > 0 %}
                            {{post.likes[0]}} and {{post.likes |length - 1}} others like this!
                            {% else %}
                            0 people like this.
                            {% endif %}
                        </div>
                        <button class='btn-primary like-btn' id='{{post.key | filterKey }}' href='/like'>Like</button>
                        <button class='btn-primary  hidden dislike-btn' id='{{post.key | filterKey }}' href='/like'>UnLike</button>
                        <div>
                            Comments
                            <div class='comments' id='{{post.key | filterKey }}'>
                                <ul class='comments-list' id='{{post.key|filterKey }}comments'>
                                    {% for comment in post.comments[-5:] %}
                                    <li>
                                        {{comment.username}} says {{comment.comment}}! {{comment.created_at}}
                                    </li>
                                    {% endfor %}
                                </ul>

                            </div>
                            </br>
                            New Comment
                            <div class='new_comment'>
                                    <input name="comment" type='text'>
                                    <input type='hidden' name='key' value='{{post.key | filterKey}}' />
                                    <button class="new_comment btn-primary" id='{{post.key | filterKey }}'>New Comment</button>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
    <p>
        {{title}}
    </p>
    <p>
        {{message}}
    </p>
    {% endfor %}
</div>

<script>
    $(document).ready(function() {
        // Like button increases likes in database and increments HTML element
        // on home page
        $('button.like-btn').click(function() {
            var post_id = this.id;
            console.log(post_id);
            $.post('/', {
                'key': post_id,
                'like': true
            }).done(function(response) {
                response = $.parseJSON(response);
                $('div#' + post_id).text(response['num_likes']);
                $('button#' + post_id + '.like-btn').addClass("hidden");
                $('button#' + post_id + '.dislike-btn').removeClass("hidden");
            }).fail(function() {
                alert('Failed to reach server');
            });
        });

        // new comment button inserts comment in database and updates homepage
        $('button.new_comment').click(function() {
            if ("{{session['username']}}") {
                var post_id = this.id;
                var comment = $('div.new_comment input:text').val();
                $.post('/', {
                    'key': post_id,
                    'comment': comment
                }).done(function(response) {
                    response = $.parseJSON(response);
                    var comment = response['comment'];
                    var input = '<li>{{session.username}} says ' + comment + '</li>';
                    $('#' + post_id + 'comments').append(input);
                }).fail(function() {
                    alert('Failed to reach server');
                });
            } else {
                $('p.error').text('You need to login or register to comment.');
            }

        });
        return false;
    });
</script>
{% endblock %}
